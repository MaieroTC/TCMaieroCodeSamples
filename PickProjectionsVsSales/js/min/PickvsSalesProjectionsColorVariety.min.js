var level,altLevel,colorHead=[],colorSummary={};function BuildByColor(e,t,a,o){var l=CreateUniqueColorList(e);$.each(l,function(l,r){var i=e.filter(e=>e.COLORCODE==r);(colorSummary=Object.assign({},i[0])).GUESSSALEPROJECTIONS=[],colorSummary.INTRANSITPROJECTIONS=[],colorSummary.PICKPROJECTIONS=[],colorSummary.SALESPROJECTIONS=[],colorSummary.STARTINGINVENTORY=[],delete colorSummary.SHORT_NAME,delete colorSummary.TYPE,delete colorSummary.TYPEVARIETY,delete colorSummary.VARIETY,delete colorSummary.VARIETY_NAME,BuildHeader(i,t,a,o),colorHead.push(colorSummary)})}function CreateUniqueColorObjectForSearch(e){var t={},a=[];return $.each(e,function(e,o){var l=o.COLORCODE;l in t||(t[l]=1,t.COLOR_DESCRIPTION=o.COLOR_DESCRIPTION,t.COLORCODE=o.COLORCODE,a.push(t))}),a}function CreateUniqueColorList(e){var t={},a=[];return $.each(e,function(e,o){var l=o.COLORCODE;l in t||(t[l]=1,a.push(l))}),a}function BuildHeader(e,t,a,o){$.each(e,function(l,r){level="flowerVariety",0==l&&$(".picksVsSaleProjection-div").append('<div class ="row type-container level-color" id="'+r.COLORCODE.trim()+'"><div class = "variety-collapse variety-collapse-row card" data-toggle="collapse" href="#collapse-head-'+r.COLORCODE.trim()+'" role="button" aria-expanded="false" aria-controls="collapseExample">Click for Variety Details<div class="collapse" id="collapse-head-'+r.COLORCODE.trim()+'"><div class="card-body" id="collapse-body-'+r.COLORCODE.trim()+'"></div></div></div></div>'),$("#collapse-body-"+r.COLORCODE.trim()).append('<div class="row type-container level-variety" id="'+r.VARIETY+'"><div class="col"><h3 class="picksVsSaleProjection-h3"><a data-flowerDescription="'+r.VARIETY_NAME+'" data-flowervariety="'+r.VARIETY+'" data-typerow-index="'+l+'" data-colorcode="'+r.COLORCODE.trim()+'" data-color="'+r.COLOR_DESCRIPTION.trim()+'">'+r.VARIETY_NAME+" - "+r.VARIETY+" - "+r.COLOR_DESCRIPTION.trim()+'</a></h3></div><div class="row"><div class="row divisionList-div" id="level-container-'+r.VARIETY+'"></div></div></div>'),BuildTable(l,r,t,a,o,level),l==e.length-1&&($("#"+r.COLORCODE.trim()).prepend('<div class="col"><h3 class="picksVsSaleProjection-h3"><a "data-typerow-index="'+l+'" data-colorcode="'+r.COLORCODE.trim()+'" data-color="'+r.COLOR_DESCRIPTION.trim()+'">'+r.COLOR_DESCRIPTION.trim()+'</a></h3></div><div class="row"><div class="row divisionList-div" id="level-container-'+r.COLORCODE.trim()+'"></div></div>'),BuildTable(l,r,t,a,o,level="flowerColor"))}),PopulateScrollSpySearchColor(e)}function BuildTable(e,t,a,o,l,r,i){$.each(["ARCATA","OXNARD","CANADA"],function(l,i){BuildDivisionsAndTableHeaders(a,o,i,e,t,r),PopulateBasePickVsSalesTableByType(e,t,i,a,o,r)})}function BuildDivisionsAndTableHeaders(e,t,a,o,l,r){var i;"flowerVariety"==r?i="VARIETY":"flowerColor"==r&&(i="COLORCODE"),$("#level-container-"+l[i]).append('<div class="col collapse-control"><h5 data-toggle="collapse"data-target = ".collapse-'+a+"-"+l[i]+'" aria-expanded="false" aria-controls="collapse-'+a+"-"+l[i]+'" class = "active-farmnet-Color font-weight-bold rounded-border cursor-change" >'+a+'<i class = "sm-pad-left far fa-minus-square collapse-icon"></i></h5><div class="table-responsive" data-division ="'+a+'"><table id ="'+a+"-"+l[i]+'" class="rounded-border table picksVsSaleProjection-table"><thead><tr class = "pickVsSalesHeader table-active"><th></th><th>Starting Inventory</th><th>Todays Sales</th></tr></thead><tbody class="divisionProjections collapse show collapse-'+a+"-"+l[i]+'"></tbody><tfoot class="divisionProjectionsTotal rounded-border"></tfoot></table></div></div>');var n=BuildDayColumns(e,t);$("#"+a+"-"+l[i]+" .pickVsSalesHeader").append(n),$("#"+a+"-"+l[i]+" .pickVsSalesHeader").append('<th class = "rowTotal">Totals</th>')}function BuildDayColumns(e,t){for(var a,o=moment(e);o.diff(t,"days")<=0;o.add(1,"days"))a+='<th data-date="'+moment(o).format("l")+'">'+moment(o).format("l")+"</th>";return a}function PopulateBasePickVsSalesTableByType(e,t,a,o,l,r){PickProjectionsPopulate(e,t,a,o,l,r),InTransitPopulate(e,t,a,o,l,r),SalesProjectionsPopulate(e,t,a,o,l,r),GuessSalesProjectionPopulate(e,t,a,o,l,r),RunningTotalPopulate(e,t,a,o,l,r)}function PickProjectionsPopulate(e,t,a,o,l,r){var i=0;"flowerVariety"==r?(level="VARIETY",altLevel="FLOWERVARIETY"):"flowerColor"==r&&(level="COLORCODE"),$("#"+a+"-"+t[level]+" .divisionProjections").append("<tr id=picks-"+a+"-"+t[level]+"><td>Picks</td><td></td><td></td></tr>");for(var n=moment(o);n.diff(l,"days")<=0;n.add(1,"days")){var s=t.PICKPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(n).format("L"));if("flowerVariety"==r){if($("#picks-"+a+"-"+t[level]).append("<td class= drilldown  data-picks-date="+moment(s.DATEKEY).format("L")+" data-picks-division="+a+" data-picks-totelStems="+s.TOTALPROJECTEDPICKSTEMS+">"+s.TOTALPROJECTEDPICKSTEMS+"</td>"),i+=s.TOTALPROJECTEDPICKSTEMS,colorSummary.PICKPROJECTIONS.length>0)var O=colorSummary.PICKPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(n).format("L")&&e.COLORCODE==t.COLORCODE.trim());if(void 0===O){var T={};T.DATEKEY=moment(s.DATEKEY).format("L"),T.DIVISION=a,T.DISPLAYDATE=moment(s.DATEKEY).format("L"),T.COLORCODE=t.COLORCODE.trim(),T.COLOR_DESCRIPTION=t.COLOR_DESCRIPTION.trim(),T.TOTALPROJECTEDPICKSTEMS=s.TOTALPROJECTEDPICKSTEMS,colorSummary.PICKPROJECTIONS.push(T)}else O.TOTALPROJECTEDPICKSTEMS=O.TOTALPROJECTEDPICKSTEMS+s.TOTALPROJECTEDPICKSTEMS}else if("flowerColor"==r){O=colorSummary.PICKPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(n).format("L")&&e.COLORCODE==t.COLORCODE);$("#picks-"+a+"-"+t[level]).append("<td class= drilldown  data-picks-date="+moment(O.DATEKEY).format("L")+" data-picks-division="+a+" data-picks-totelStems="+O.TOTALPROJECTEDPICKSTEMS+">"+O.TOTALPROJECTEDPICKSTEMS+"</td>"),i+=O.TOTALPROJECTEDPICKSTEMS}}$("#picks-"+a+"-"+t[level]).append("<td class= drilldown  data-picks-division="+a+" data-picks-totelStems="+i+">"+i+"</td>")}function InTransitPopulate(e,t,a,o,l,r){var i=0;"flowerVariety"==r?(level="VARIETY",altLevel="FLOWERVARIETY"):"flowerColor"==r&&(level="COLORCODE"),$("#"+a+"-"+t[level]+" .divisionProjections").append("<tr id= inTransit-"+a+"-"+t[level]+"><td>In-Transit</td><td></td><td></td></tr>");for(var n=moment(o);n.diff(l,"days")<=0;n.add(1,"days")){var s=t.INTRANSITPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(n).format("L"));if("flowerVariety"==r){if($("#inTransit-"+a+"-"+t[level]).append("<td class= drilldown  data-inTransit-date="+moment(s.DATEKEY).format("L")+" data-inTransit-division="+a+" data-inTransit-totelStems="+s.TOTALPROJECTEDSTEMS+">"+s.TOTALPROJECTEDSTEMS+"</td>"),i=s.TOTALPROJECTEDSTEMS+i,colorSummary.INTRANSITPROJECTIONS.length>0)var O=colorSummary.INTRANSITPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(n).format("L")&&e.COLORCODE==t.COLORCODE.trim());if(void 0===O){var T={};T.DATEKEY=moment(s.DATEKEY).format("L"),T.DIVISION=a,T.DISPLAYDATE=moment(s.DATEKEY).format("L"),T.COLORCODE=t.COLORCODE.trim(),T.COLOR_DESCRIPTION=t.COLOR_DESCRIPTION.trim(),T.TOTALPROJECTEDSTEMS=s.TOTALPROJECTEDSTEMS,colorSummary.INTRANSITPROJECTIONS.push(T)}else O.TOTALPROJECTEDSTEMS=O.TOTALPROJECTEDSTEMS+s.TOTALPROJECTEDSTEMS}else if("flowerColor"==r){O=colorSummary.INTRANSITPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(n).format("L")&&e.COLORCODE==t.COLORCODE);$("#inTransit-"+a+"-"+t[level]).append("<td class= drilldown  data-inTransit-date="+moment(O.DATEKEY).format("L")+" data-inTransit-division="+a+" data-inTransit-totelStems="+O.TOTALPROJECTEDSTEMS+">"+O.TOTALPROJECTEDSTEMS+"</td>"),i=s.TOTALPROJECTEDSTEMS+i}}$("#inTransit-"+a+"-"+t[level]).append("<td class= drilldown  data-inTransit-division="+a+" data-inTransit-totelStems="+i+">"+i+"</td>")}function SalesProjectionsPopulate(e,t,a,o,l,r){var i=0;"flowerVariety"==r?(level="VARIETY",altLevel="FLOWERVARIETY"):"flowerColor"==r&&(level="COLORCODE",altLevel="COLORCODE");var n=moment(o).subtract(1,"d");$("#"+a+"-"+t[level]+" .divisionProjections").append("<tr id=sales-"+a+"-"+t[level]+"><td>Sales</td><td></td></tr>");for(var s=moment(n);s.diff(l,"days")<=0;s.add(1,"days")){var O=t.SALESPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DISPLAYDATE).format("L")==moment(s).format("L"));if("flowerVariety"==r){if($("#sales-"+a+"-"+t[level]).append("<td class= drilldown data-sales-date="+moment(O.DATEKEY).format("L")+" data-sales-division="+a+" data-sales-totelStems="+O.TOTALPROJECTEDSALESSTEMS+">"+O.TOTALPROJECTEDSALESSTEMS+"</td>"),i+=O.TOTALPROJECTEDSALESSTEMS,colorSummary.SALESPROJECTIONS.length>0)var T=colorSummary.SALESPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DISPLAYDATE).format("L")==moment(s).format("L")&&e.COLORCODE==t.COLORCODE.trim());if(void 0===T){var d={};d.DATEKEY=moment(O.DATEKEY).format("L"),d.DIVISION=a,d.DISPLAYDATE=moment(O.DISPLAYDATE).format("L"),d.COLORCODE=t.COLORCODE.trim(),d.COLOR_DESCRIPTION=t.COLOR_DESCRIPTION.trim(),d.TOTALPROJECTEDSALESSTEMS=O.TOTALPROJECTEDSALESSTEMS,colorSummary.SALESPROJECTIONS.push(d)}else T.TOTALPROJECTEDSALESSTEMS=T.TOTALPROJECTEDSALESSTEMS+O.TOTALPROJECTEDSALESSTEMS}else if("flowerColor"==r){T=colorSummary.SALESPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DISPLAYDATE).format("L")==moment(s).format("L")&&e.COLORCODE==t.COLORCODE.trim());$("#sales-"+a+"-"+t[level]).append("<td class= drilldown data-sales-date="+moment(T.DATEKEY).format("L")+" data-sales-division="+a+" data-sales-totelStems="+T.TOTALPROJECTEDSALESSTEMS+">"+T.TOTALPROJECTEDSALESSTEMS+"</td>"),i+=T.TOTALPROJECTEDSALESSTEMS}}$("#sales-"+a+"-"+t[level]).append("<td class= drilldown  data-sales-division="+a+" data-sales-totelStems="+i+">"+i+"</td>")}function GuessSalesProjectionPopulate(e,t,a,o,l,r){var i=0;"flowerVariety"==r?(level="VARIETY",altLevel="FLOWERVARIETY"):"flowerColor"==r&&(level="COLORCODE",altLevel="COLORCODE");var n=moment(o).subtract(1,"d");$("#"+a+"-"+t[level]+" .divisionProjections").append("<tr id=guessSales-"+a+"-"+t[level]+"><td>Guess</td><td></td></tr>");for(var s=moment(n);s.diff(l,"days")<=0;s.add(1,"days")){var O=t.GUESSSALEPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DISPLAYDATE).format("L")==moment(s).format("L"));if("flowerVariety"==r){if($("#guessSales-"+a+"-"+t.VARIETY).append("<td class= drilldown  data-guessSales-date="+moment(O.DATEKEY).format("L")+" data-guessSales-division="+a+" data-guessSales-totelStems="+O.TOTALPROJECTEDSALESSTEMS+">"+O.TOTALPROJECTEDSALESSTEMS+"</td>"),i=O.TOTALPROJECTEDSALESSTEMS+i,colorSummary.GUESSSALEPROJECTIONS.length>0)var T=colorSummary.GUESSSALEPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DISPLAYDATE).format("L")==moment(s).format("L")&&e.COLORCODE==t.COLORCODE.trim());if(void 0===T){var d={};d.DATEKEY=moment(O.DATEKEY).format("L"),d.DIVISION=a,d.DISPLAYDATE=moment(O.DISPLAYDATE).format("L"),d.COLORCODE=t.COLORCODE.trim(),d.COLOR_DESCRIPTION=t.COLOR_DESCRIPTION.trim(),d.TOTALPROJECTEDSALESSTEMS=O.TOTALPROJECTEDSALESSTEMS,colorSummary.GUESSSALEPROJECTIONS.push(d)}else T.TOTALPROJECTEDSALESSTEMS=T.TOTALPROJECTEDSALESSTEMS+O.TOTALPROJECTEDSALESSTEMS}else if("flowerColor"==r){T=colorSummary.GUESSSALEPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DISPLAYDATE).format("L")==moment(s).format("L")&&e.COLORCODE==t.COLORCODE.trim());$("#guessSales-"+a+"-"+t[level]).append("<td class= drilldown  data-guessSales-date="+moment(T.DATEKEY).format("L")+" data-guessSales-division="+a+" data-guessSales-totelStems="+T.TOTALPROJECTEDSALESSTEMS+">"+T.TOTALPROJECTEDSALESSTEMS+"</td>"),i=T.TOTALPROJECTEDSALESSTEMS+i}}$("#guessSales-"+a+"-"+t[level]).append("<td class= drilldown  data-guessSales-division="+a+" data-guessSales-totelStems="+i+">"+i+"</td>")}function RunningTotalPopulate(e,t,a,o,l,r){"flowerVariety"==r?(level="VARIETY",altLevel="FLOWERVARIETY"):"flowerColor"==r&&(level="COLORCODE",altLevel="COLORCODE");var i=t.STARTINGINVENTORY.find(e=>e.DIVISION==a);$("#"+a+"-"+t[level]+" .divisionProjectionsTotal").append('<tr class = "table-info"  id=runningTotal-'+a+"-"+i[level]+'><td class = "font-weight-bold">Running Total</td></tr>');var n=!1,s=moment(o).subtract(1,"days").format("L");if("flowerVariety"==r){if($("#runningTotal-"+a+"-"+i[level]).append('<td class = "font-weight-bold" id = runningTotal-'+a+"-"+moment(s).subtract(1,"days").unix()+"-"+i[level]+" data-runningTotal-division="+a+" data-runningTotal-type="+i[level]+" data-runningTotal-totelStems="+i.TOTAL+">"+i.TOTAL+"</td>"),colorSummary.STARTINGINVENTORY.length>0)var O=colorSummary.STARTINGINVENTORY.find(e=>e.DIVISION==a&&e.COLORCODE==t.COLORCODE.trim()&&moment(e.DATEKEY).format("L")==moment(s).subtract(1,"days").format("L"));if(void 0===O)(d={}).DIVISION=a,d.COLORCODE=t.COLORCODE.trim(),d.COLOR_DESCRIPTION=t.COLOR_DESCRIPTION.trim(),d.TOTAL=i.TOTAL,d.DATEKEY=moment(s).subtract(1,"days").format("L"),colorSummary.STARTINGINVENTORY.push(d);else O.TOTAL=O.TOTAL+i.TOTAL;for(var T=moment(s);T.diff(l,"days")<=0;T.add(1,"days")){var d,E=moment(T).subtract(1,"d").format("L"),S=t.SALESPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DISPLAYDATE).format("L")==moment(T).format("L")),m=t.INTRANSITPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(T).format("L")),C=t.PICKPROJECTIONS.find(e=>e.DIVISION==a&&moment(e.DATEKEY).format("L")==moment(T).format("L")),c=$("#runningTotal-"+a+"-"+moment(E).unix()+"-"+i[level]).html();if(inTransitRunning=void 0===m?0:m.TOTALPROJECTEDSTEMS,pickRunning=void 0===C?0:C.TOTALPROJECTEDPICKSTEMS,totalStems=c-S.TOTALPROJECTEDSALESSTEMS+inTransitRunning+pickRunning,colorSummary.STARTINGINVENTORY.length>0)O=colorSummary.STARTINGINVENTORY.find(e=>e.DIVISION==a&&e.COLORCODE==t.COLORCODE.trim()&&moment(e.DATEKEY).format("L")==moment(T).format("L"));if(void 0===O)(d={}).DIVISION=a,d.COLORCODE=t.COLORCODE.trim(),d.COLOR_DESCRIPTION=t.COLOR_DESCRIPTION.trim(),d.TOTAL=totalStems,d.DATEKEY=moment(T).format("L"),colorSummary.STARTINGINVENTORY.push(d);else O.TOTAL=O.TOTAL+totalStems;n=0==totalStems,$("#runningTotal-"+a+"-"+i[level]).append('<td class = "font-weight-bold" id = runningTotal-'+a+"-"+moment(T).unix()+"-"+i[level]+">"+totalStems+"</td>")}1==n&&$(".collapse-"+a+"-"+i[level]).collapse({hide:!0}),$("tr#runningTotal-"+a+"-"+i[level]).find("td").each(function(){$(this).html()<0&&$(this).addClass("redText")}),$(".collapse-control").on("shown.bs.collapse",function(){$(this).find(".fa-plus-square").removeClass("fa-plus-square").addClass("fa-minus-square")}),$(".collapse-control").on("hidden.bs.collapse",function(){$(this).find(".fa-minus-square").removeClass("fa-minus-square").addClass("fa-plus-square")})}else if("flowerColor"==r){for(T=moment(s).subtract(1,"days");T.diff(l,"days")<=0;T.add(1,"days")){O=colorSummary.STARTINGINVENTORY.find(e=>e.DIVISION==a&&e.COLORCODE.trim()==t.COLORCODE.trim()&&moment(e.DATEKEY).format("L")==moment(T).format("L"));$("#runningTotal-"+a+"-"+O[level]).append('<td class = "font-weight-bold" id = runningTotal-'+a+"-"+moment(T).unix()+"-"+O[level]+" data-runningTotal-division="+a+" data-runningTotal-type="+O[level]+" data-runningTotal-totelStems="+O.TOTAL+">"+O.TOTAL+"</td>"),n=0==O.TOTAL}1==n&&$(".collapse-"+a+"-"+i[level]).collapse({hide:!0}),$("tr#runningTotal-"+a+"-"+i[level]).find("td").each(function(){$(this).html()<0&&$(this).addClass("redText")}),$(".collapse-control").on("shown.bs.collapse",function(){$(this).find(".fa-plus-square").removeClass("fa-plus-square").addClass("fa-minus-square")}),$(".collapse-control").on("hidden.bs.collapse",function(){$(this).find(".fa-minus-square").removeClass("fa-minus-square").addClass("fa-plus-square")})}$("#runningTotal-"+a+"-"+t[level]).append('<td class = "font-weight-bold"</td>')}function PopulateScrollSpySearchVariety(e){$.each(e,function(e,t){$("#scrollJump-select").append($("<option value ="+t.VARIETY+">"+t.VARIETY_NAME+"-"+t.VARIETY+"</option>"))})}function PopulateScrollSpySearchColor(e){var t=CreateUniqueColorObjectForSearch(e);$.each(t,function(e,t){$("#scrollJump-select").append($("<option value ="+t.COLORCODE+">"+t.COLOR_DESCRIPTION+"-"+t.COLORCODE+"</option>"))})}$(document).ready(function(){var e=function(e){var t,a,o=window.location.search.substring(1).split("&");for(a=0;a<o.length;a++)if((t=o[a].split("="))[0]===e)return void 0===t[1]||decodeURIComponent(t[1])},t=e("startDate"),a=e("endDate"),o=e("flowerType"),l=e("flowerdescription");$("head title",window.parent.document).text(l+"-"+o),$(".title").html("Projections - Picks vs Sales - "+l+" - "+o),$.ajax({type:"POST",url:"/MM/PickProjectionsVsSales/reports/dataPages/PickVsSalesProjectionsVarietyDrillDownData.cfm?startDate="+t+"&endDate="+a+"&flowerType="+o,dataType:"JSON",async:!0,success:function(e){BuildByColor(e,t,a,"flowerVariety")}})}),$(document).ajaxStart(function(){$(".picksVsSaleProjection-div").loading("start"),$("#scrollJump-select").children().remove()}),$(document).ajaxStop(function(){$(".picksVsSaleProjection-div").loading("stop"),$(".drilldown").on("click",function(){console.log("clicked")}),$("#scrollJump").on("click",function(e){var t=$("#scrollJump-select").val(),a=$("#"+t).offset().top-$(".get-height").outerHeight();$("body,html").animate({scrollTop:a})})});
